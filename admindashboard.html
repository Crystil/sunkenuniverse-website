<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Sunken Universe</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root{
          --bg:#05080f;
          --panel:#0b1220;
          --accent:#4df2d6;
          --accent2:#5b8cff;
          --text:#e6ebf2;
          --muted:#9aa4b2;
          --danger:#ff6b6b;
          --border:#162040;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
          font-family:Inter,sans-serif;
          background:radial-gradient(1200px 600px at 20% 10%,#0b1530,var(--bg));
          color:var(--text);
          min-height:100vh;
        }
        header{
          padding:20px 8%;
          border-bottom:1px solid #121a2f;
          display:flex;justify-content:space-between;align-items:center;
          background:rgba(5,8,15,.75);backdrop-filter:blur(12px)
        }
        .brand{font-weight:900}
        .right{display:flex;gap:10px;align-items:center}
        .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:.8rem}
        .logout{padding:10px 14px;border-radius:14px;border:none;cursor:pointer;font-weight:800;
        background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041017}
        main{padding:56px 8%}
        .tabs{display:flex;gap:12px;margin-bottom:18px}
        .tab{padding:12px 20px;border-radius:14px;border:1px solid var(--border);cursor:pointer;color:var(--muted);font-weight:600}
        .tab.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#041017;border-color:transparent}
        .panel{background:linear-gradient(180deg,#0b1220,#05080f);border:1px solid var(--border);border-radius:22px;padding:26px}
        table{width:100%;border-collapse:collapse}
        th,td{padding:14px 10px;border-bottom:1px solid var(--border);font-size:.95rem}
        th{color:var(--muted)}
        .actions{display:flex;gap:8px}
        .btn{padding:8px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
        .approve{background:var(--accent)}
        .reject{background:var(--danger)}
        .view{background:#1b2440;color:#c7d2fe}
        .delete{background:#3d1f1f;color:#ff9a9a}
        .status{padding:6px 12px;border-radius:999px;font-size:.75rem;font-weight:800}
        .pending{background:#1b2440}
        .approved{background:#0f3d2e}
        .rejected{background:#3d1f1f}
        .empty{text-align:center;color:var(--muted)}

        .admin-panel{margin-top:40px}
        .admin-panel input{padding:12px;border-radius:14px;border:1px solid var(--border);background:#05080f;color:var(--text)}

        .modal{
          position:fixed;inset:0;
          background:rgba(0,0,0,.6);
          display:none;align-items:center;justify-content:center;
        }
        .modal-content{
          background:var(--panel);
          padding:30px;
          border-radius:18px;
          max-width:600px;
          width:90%;
          max-height:80vh;
          overflow:auto;
        }
        .modal-content h2{margin-bottom:14px}
        .modal-content p{margin-bottom:8px;color:var(--muted)}
        .close{margin-top:20px}
    </style>
</head>

<body>

<header>
    <div class="brand">Sunken Universe — Admin Dashboard</div>
    <div class="right">
        <span class="pill" id="adminEmail">Loading…</span>
        <button class="logout" id="logoutBtn">Logout</button>
    </div>
</header>

<main>
    <div class="tabs">
        <div class="tab active" data-type="actors">Actors</div>
        <div class="tab" data-type="builders">Builders</div>
        <div class="tab" data-type="staff">Staff</div>
    </div>

    <div class="panel">
        <table>
            <thead>
            <tr>
                <th>Discord Name</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="appTable">
            <tr><td colspan="4" class="empty">Loading…</td></tr>
            </tbody>
        </table>
    </div>

    <div class="panel admin-panel">
        <h3>Add Admin</h3>
        <input type="email" id="newAdminEmail" placeholder="admin@email.com">
        <button class="btn approve" id="addAdminBtn">Add</button>
    </div>
</main>

<!-- MODAL -->
<div class="modal" id="modal">
    <div class="modal-content">
        <h2>Application Details</h2>
        <div id="modalBody"></div>
        <button class="btn approve close" onclick="closeModal()">Close</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore,collection,onSnapshot,doc,updateDoc,deleteDoc,getDoc,setDoc,serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
     apiKey:"AIzaSyBDUKl5Pn4_in6kvgvuLKP5S6Pm2fDDKz8",
     authDomain:"sunkensmp.firebaseapp.com",
     projectId:"sunkensmp"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const SUPER_ADMIN="e85972080@gmail.com";
    let currentType="actors", unsubscribe;

    const table=document.getElementById("appTable");
    const modal=document.getElementById("modal");
    const modalBody=document.getElementById("modalBody");

    onAuthStateChanged(auth, async user=>{
     if(!user) return location.href="loginregister.html";
     document.getElementById("adminEmail").textContent=user.email;

     const adminSnap=await getDoc(doc(db,"admins",user.email));
     if(!adminSnap.exists() && user.email!==SUPER_ADMIN){
       await signOut(auth);
       location.href="loginregister.html";
     }
     loadApps();
    });

    document.querySelectorAll(".tab").forEach(tab=>{
     tab.onclick=()=>{
       document.querySelector(".tab.active").classList.remove("active");
       tab.classList.add("active");
       currentType=tab.dataset.type;
       loadApps();
     };
    });

    function loadApps(){
     if(unsubscribe) unsubscribe();
     table.innerHTML='<tr><td colspan="4" class="empty">Loading…</td></tr>';

     unsubscribe=onSnapshot(collection(db,"applications",currentType,"submissions"),snap=>{
      table.innerHTML="";
      if(snap.empty){
        table.innerHTML='<tr><td colspan="4" class="empty">No applications</td></tr>';
        return;
      }
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td>${d.name||"-"}</td>
          <td>${d.role||"-"}</td>
          <td><span class="status ${d.status||"pending"}">${d.status||"pending"}</span></td>
          <td class="actions">
            <button class="btn view">See More</button>
            <button class="btn approve">Approve</button>
            <button class="btn reject">Reject</button>
            <button class="btn delete">Delete</button>
          </td>`;

        tr.querySelector(".view").onclick=()=>openModal(d);
        tr.querySelector(".approve").onclick=()=>updateDoc(doc(db,"applications",currentType,"submissions",docSnap.id),{status:"approved"});
        tr.querySelector(".reject").onclick=()=>updateDoc(doc(db,"applications",currentType,"submissions",docSnap.id),{status:"rejected"});
        tr.querySelector(".delete").onclick=async()=>{
          if(confirm("Delete this application?")){
            await deleteDoc(doc(db,"applications",currentType,"submissions",docSnap.id));
          }
        };
        table.appendChild(tr);
      });
     });
    }

    function openModal(data){
     modalBody.innerHTML="";
     Object.entries(data).forEach(([k,v])=>{
       modalBody.innerHTML+=`<p><strong>${k}:</strong> ${v}</p>`;
     });
     modal.style.display="flex";
    }
    window.closeModal=()=>modal.style.display="none";

    document.getElementById("logoutBtn").onclick=async()=>{
     await signOut(auth);
     location.href="loginregister.html";
    };

    document.getElementById("addAdminBtn").onclick=async()=>{
     const email=document.getElementById("newAdminEmail").value.trim();
     if(!email) return;
     await setDoc(doc(db,"admins",email),{email,addedAt:serverTimestamp()});
     alert("Admin added");
    };
</script>

</body>
</html>
